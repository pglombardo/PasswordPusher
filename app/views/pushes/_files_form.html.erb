<% title(_('Securely Send Files')) %>
<% if tus_uploads_enabled? %>
  <% content_for :head do %>
    <%= javascript_include_tag "tus", "data-turbo-track": "reload", type: "module" %>
  <% end %>
<% end %>

<div class='container'
    data-controller="knobs form"
    data-knobs-tab-name-value="file"
    data-knobs-lang-day-value="<%= _('Day') %>"
    data-knobs-lang-days-value="<%= _('Days') %>"
    data-knobs-default-days-value="<%= @push.persisted? ? @push.days_remaining : @push.settings_for_kind.expire_after_days_default %>"
    data-knobs-lang-view-value="<%= _('View') %>"
    data-knobs-lang-views-value="<%= _('Views') %>"
    data-knobs-default-views-value="<%= @push.persisted? ? @push.views_remaining : @push.settings_for_kind.expire_after_views_default %>"
    data-knobs-lang-save-value="<%= _('Save') %>"
    data-knobs-lang-saved-value="<%= _('Saved!') %>"
    data-knobs-default-retrieval-step-value="<%= @push.settings_for_kind.retrieval_step_default %>"
    data-knobs-default-deletable-by-viewer-value="<%= @push.settings_for_kind.deletable_pushes_default %>"
    data-knobs-ga-enabled-value="<%= ENV.key?('GA_ENABLE') %>">
<%= render partial: "shared/topnav" %>

<%= form_for @push, data: { action: 'form#submit' } do |f| %>
    <%= render partial: "pushes/error", locals: {push: @push} %>

    <%= f.hidden_field :kind, value: :file unless action_name == 'edit' %>

    <div class='row'>
        <div class='col-sm-8'>
            <% if @push.persisted? && @push.files.any? %>
                <div class='row mb-3'>
                    <div class='col'>
                        <div class="card">
                            <h5 class="card-header"><%= _('Uploaded Files') %></h5>
                            <div class="card-body">
                                <div class="list-group">
                                    <% @push.files.each do |file| %>
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>
                                                <i class="bi bi-file-earmark"></i>
                                                <%= file.filename %>
                                                <small class="text-muted">(<%= number_to_human_size(file.byte_size) %>)</small>
                                            </span>
                                            <% if @push.files.count > 1 %>
                                                <%= link_to delete_file_push_path(@push, file_id: file.id),
                                                    method: :delete,
                                                    class: "btn btn-sm btn-outline-danger",
                                                    data: {
                                                      turbo_method: :delete,
                                                      turbo_confirm: _('Are you sure you want to delete this file?')
                                                    } do %>
                                                    <i class="bi bi-trash"></i>
                                                <% end %>
                                            <% end %>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% end %>
            <div class='row mb-3'>
                <div class='col'>
                    <div class="card">
                        <h5 class="card-header"><%= _('Add Files...') %></h5>
                        <div class="card-body">
                            <%= render "pushes/tus_upload_row_template" %>
                            <%= render "pushes/direct_upload_row_template" %>
                            <%= render "pushes/selected_file_row_template" %>
                            <ul id="progress-bars" class="list-group mb-2" aria-label="Upload progress"></ul>
                            <div data-controller="multi-upload"
                                 data-multi-upload-max-files-value="<%= @push.settings_for_kind.max_file_uploads %>"
                                 data-multi-upload-max-tus-size-value="<%= Settings.files.max_tus_upload_size.to_i %>"
                                 data-multi-upload-max-direct-size-value="<%= Settings.files.max_direct_upload_size.to_i %>"
                                 data-multi-upload-file-too-large-message-value="<%= _('"%{filename}" is too large. Max size per file is %{size}.') %>"
                                 data-multi-upload-max-files-message-value="<%= _('You can only upload %{count} files at a time.') %>"
                                 data-multi-upload-finalizing-label-value="<%= _('Finalizingâ€¦') %>"
                                 data-multi-upload-tus-enabled-value="<%= tus_uploads_enabled? %>"
                                 data-multi-upload-tus-endpoint-value="<%= tus_uploads_url %>"
                                 data-multi-upload-files-input-name-value="push[files][]">
                                <ul id="selected-files" data-multi-upload-target="files" class="list-group" aria-label="Selected files"></ul>
                                <div class="file my-3">
                                    <%= f.file_field :files,
                                                     multiple: true,
                                                     required: !@push.persisted?,
                                                     direct_upload: !tus_uploads_enabled?,
                                                     class: "form-control",
                                                     "data-action": "multi-upload#addFile" %>
                                </div>
                            </div>
                        </div>
                        <div id="file-count-footer" class="card-footer text-muted">
                          <%= _('You can upload up to %{count} files per push.') % { count: @push.settings_for_kind.max_file_uploads } %>
                          <% if tus_uploads_enabled? %>
                            <%= _('Max %{size} per file.') % { size: number_to_human_size(Settings.files.max_tus_upload_size.to_i) } %>
                          <% else %>
                            <%= _('Max %{size} per file.') % { size: number_to_human_size(Settings.files.max_direct_upload_size.to_i) } %>
                          <% end %>
                        </div>
                    </div>
                </div>
            </div>
            <div class='row'>
                <div><%= _('Expire secret link and delete after:') %></div>
                <div class='col-10'>
                    <%= range_field_tag("push_expire_after_days", @push.persisted? ? @push.days_remaining : @push.settings_for_kind.expire_after_days_default,
                                        { :name => "push[expire_after_days]",
                                          :class => "form-range",
                                          :min => action_name == 'edit' ? @push.days_old + 1 : @push.settings_for_kind.expire_after_days_min,
                                          :max => @push.settings_for_kind.expire_after_days_max,
                                          :step => "1",
                                          "data-action" => "change->knobs#updateDaysSlider input->knobs#updateDaysSlider",
                                          "data-knobs-target" => "daysRange"
                                          }) %>
                </div>
                <div class='col-2'>
                    <div class="form-text" data-knobs-target="daysRangeLabel"><%= @push.persisted? ? @push.days_remaining : @push.settings_for_kind.expire_after_days_default %> <%= _('Days') %></div>
                </div>
            </div>

            <div class='row'>
                <div class='col-10'>
                    <%= range_field_tag("push_expire_after_views", @push.persisted? ? @push.views_remaining : @push.settings_for_kind.expire_after_views_default,
                                       { :name => "push[expire_after_views]",
                                         :class => "form-range",
                                         :min => action_name == 'edit' ? @push.view_count + 1 : @push.settings_for_kind.expire_after_views_min,
                                         :max => @push.settings_for_kind.expire_after_views_max,
                                         :step => "1",
                                         "data-action" => "change->knobs#updateViewsSlider input->knobs#updateViewsSlider",
                                         "data-knobs-target" => "viewsRange"
                                         }) %>
                </div>

                <div class='col-2'>
                    <div class="form-text" data-knobs-target="viewsRangeLabel"><%= @push.persisted? ? @push.views_remaining : @push.settings_for_kind.expire_after_views_default %> <%= _('Views') %></div>
                </div>
            </div>
            <div class='row'>
                <div class='col'>
                    <p class='text-center form-text'><%= _('(whichever comes first)') %></p>
                </div>
            </div>

            <div class='row mb-3'>
                <div class='col'>
                    <div class="list-group mx-0">
                        <% if @push.settings_for_kind.enable_retrieval_step %>
                            <label class="list-group-item d-flex gap-2">
                            <%= check_box_tag "push[retrieval_step]", '1', @push.persisted? ? @push.retrieval_step : @push.settings_for_kind.retrieval_step_default, checkbox_options_for_push(@push, "retrievalStep", @push.settings_for_kind.retrieval_step_default) %>
                            <span>
                                <%= _('Use a 1-click retrieval step') %>
                                <small class="d-block text-muted"><%= _('Helps to avoid chat systems and URL scanners from eating up views.') %></small>
                            </span>
                            </label>
                        <% end %>
                        <% if @push.settings_for_kind.enable_deletable_pushes %>
                            <label class="list-group-item d-flex gap-2">
                            <%= check_box_tag "push[deletable_by_viewer]", '1', @push.persisted? ? @push.deletable_by_viewer : @push.settings_for_kind.deletable_pushes_default, checkbox_options_for_push(@push, "deletableByViewer", @push.settings_for_kind.deletable_pushes_default) %>
                            <span>
                                <%= _('Allow immediate deletion') %>
                                <small class="d-block text-muted"><%= _('Allow users to delete this push once retrieved.') %></small>
                            </span>
                            </label>
                        <% end %>
                    </div>
                </div>
            </div>
            <div class='row mb-3'>
                <div class='col'>
                    <div class="input-group">
                        <span class="input-group-text"><%= _('Passphrase Lockdown') %></span>
                        <%= f.text_field(:passphrase, { class: "form-control",
                                                        autocomplete: "off",
                                                        placeholder: _('Optional: Require recipients to enter a passphrase to view this push') }) %>
                    </div>
                </div>
            </div>
            <% unless action_name == 'edit' %>
                <div class='row'>
                    <div class='col'>
                        <p class='mb-3'>
                            <div id='cookie-save'>
                                <a data-action="click->knobs#saveSettings" href="#"><%= _('Save') %></a> <%= _('the above settings as the page default.') %>
                            </div>
                        </p>
                    </div>
                </div>
            <% end %>
        </div>
        <div class='col'>
            <% if user_signed_in? %>

                <div class='row mb-3'>
                    <div class="input-group">
                        <span class="input-group-text"><%= Push.human_attribute_name(:name) %></span>
                        <%= f.text_field(:name, { class: "form-control",
                                                placeholder: _('Optional'),
                                                autocomplete: "off" }) %>
                    </div>
                    <div class="form-text" id="basic-addon4"><%= _('A name shown in the dashboard, notifications and emails.') %></div>
                </div>
            <% end %>
            <div class='row mb-3'>
                <div class="input-group">
                    <span class="input-group-text"><%= _('Message') %></span>
                    <%= f.text_area(:payload, { class: "form-control",
                                            rows: 3,
                                            placeholder: _('Optional: A message to be included with the push'),
                                            spellcheck: false,
                                            autocomplete: "off" }) %>
                </div>
                <div class="form-text" id="basic-addon4"><%= _('Encrypted and visible to the receiving party') %></div>
            </div>
            <% if user_signed_in? %>
                <div class='row mb-3'>
                    <div class="input-group">
                        <span class="input-group-text"><%= _('Reference Note') %></span>
                        <%= f.text_area(:note, { class: "form-control",
                                                rows: 1,
                                                placeholder: _('Optional'),
                                                autocomplete: "off" }) %>
                    </div>
                    <div class="form-text" id="basic-addon4"><%= _('Encrypted and visible only to you') %></div>
                </div>
            <% end %>
            <div class='row my-3 px-5'> <hr> </div>
            <div class='row mb-3'>
                <span class="text-muted">
                    <%= _('Once expired, all files and content of the push will be deleted immediately and entirely.') %>
                </span>
            </div>
            <div class='row mb-3'>
                <span class="text-muted">
                    <%= _('An audit log of activity will be available.') %>
                </span>
            </div>
        </div>
    </div>
    <div class='row'>
        <div class='col'>
            <p class='my-3'>
                <% if @push.persisted? %>
                    <button class="form-control btn btn-primary" type="submit" data-form-target="pushit" data-disable-with="<%= _('Updating...') %>"><%= _('Update Push') %></button>
                <% else %>
                    <button class="form-control btn btn-primary" type="submit" data-form-target="pushit" data-disable-with="<%= _('Pushing...') %>"><%= _('Push It!') %></button>
                <% end %>
            </p>
        </div>
    </div>
<% end %>
</div>
